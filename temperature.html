<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOC-ISP Temperature Monitor</title>
  <link rel="icon" type="image/png" href="./assets/tempalert.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #111827;
    }
    .blinking-alert {
      animation: blinker 1s linear infinite;
    }
    @keyframes blinker {
      50% { opacity: 0; }
    }
    .log-table-container::-webkit-scrollbar {
      width: 8px;
    }
    .log-table-container::-webkit-scrollbar-thumb {
      background-color: #4b5563;
      border-radius: 4px;
    }
    .log-table-container::-webkit-scrollbar-track {
      background: #1f2937;
    }
  </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-8">

<div class="w-full max-w-4xl mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-100">Temperature Monitor</h1>
    <div class="flex items-center space-x-2">
      <span id="temp-status-text" class="text-sm font-medium"></span>
      <div id="temp-status-indicator" class="w-4 h-4 rounded-full bg-yellow-500"></div>
    </div>
  </div>
  <div class="space-y-4">
    <div class="p-4 bg-gray-700 rounded-lg flex justify-between items-center">
      <div>
        <h2 class="font-semibold text-lg">MRTG S. Temperature</h2>
        <p class="text-sm text-gray-400">i350bb-pci-0600</p>
      </div>
      <div class="text-right">
        <p id="mrtg-s-temp" class="text-2xl font-bold text-gray-200">-- °C</p>
        <p class="text-xs text-gray-500">Threshold: 60 °C</p>
      </div>
    </div>
    <div class="p-4 bg-gray-700 rounded-lg flex justify-between items-center">
      <div>
        <h2 class="font-semibold text-lg">MX40-A Temp (Routing Engine)</h2>
        <p class="text-sm text-gray-400">Routing Engine Sensor</p>
      </div>
      <div class="text-right">
        <p id="mx40-re-temp" class="text-2xl font-bold text-gray-200">-- °C</p>
        <p class="text-xs text-gray-500">Threshold: 60 °C</p>
      </div>
    </div>
    <div class="p-4 bg-gray-700 rounded-lg flex justify-between items-center">
      <div>
        <h2 class="font-semibold text-lg">MX40-A Temp (Intake)</h2>
        <p class="text-sm text-gray-400">Intake Air Sensor</p>
      </div>
      <div class="text-right">
        <p id="mx40-intake-temp" class="text-2xl font-bold text-gray-200">-- °C</p>
        <p class="text-xs text-gray-500">Threshold: 75 °C</p>
      </div>
    </div>
  </div>
  <div class="mt-8">
    <h3 class="text-xl font-semibold text-gray-200 mb-3 flex justify-between items-center">
      Temperature Log
      <button id="clear-logs-btn" class="text-sm px-3 py-1 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition duration-150 shadow-sm disabled:opacity-50">
        Clear All Logs
      </button>
    </h3>
    <div class="log-table-container max-h-48 overflow-y-auto bg-gray-900 rounded-lg">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-700 sticky top-0">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Sensor</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Duration</th>
        </tr>
        </thead>
        <tbody id="temp-log-table-body" class="divide-y divide-gray-700">
        <tr><td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<audio id="alert-sound" src="./assets/alert.mp3" preload="auto"></audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script >
  // temperature.js

  // --- Core Data Fetching and Parsing Logic ---
  const TEMP_DATA_URL = './temp.html';

  async function fetchData() {
    try {
      const response = await fetch(TEMP_DATA_URL);
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const htmlString = await response.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlString, 'text/html');
      const bodyText = doc.body.innerText;

      const data = {
        mrtgTemp: null,
        mx40ReTemp: null,
        mx40IntakeTemp: null
      };

      const mrtgMatch = bodyText.match(/MRTG S\. Temperature\(.+?\):.*?(\d+)\s*°C/);
      if (mrtgMatch) data.mrtgTemp = parseInt(mrtgMatch[1], 10);

      const mx40LineMatch = bodyText.match(/MX40-A Temperature\(Routing Engine\):.*?(\d+)\s*°C.*?Intake:(\d+)\s*°C/);
      if (mx40LineMatch) {
        data.mx40ReTemp = parseInt(mx40LineMatch[1], 10);
        data.mx40IntakeTemp = parseInt(mx40LineMatch[2], 10);
      }

      return data;
    } catch (error) {
      console.error('Fetch Error:', error);
      return { mrtgTemp: null, mx40ReTemp: null, mx40IntakeTemp: null };
    }
  }

  // Global state for tracking each sensor's last known status
  const sensorStates = {
    mrtgS: { lastStatus: 'Normal', lastTimestamp: null },
    mx40Re: { lastStatus: 'Normal', lastTimestamp: null },
    mx40Intake: { lastStatus: 'Normal', lastTimestamp: null }
  };

  async function updateDashboardData() {
    const data = await fetchData();
    if (data) {
      processSensorData(data);
    } else {
      processSensorData({ mrtgTemp: null, mx40ReTemp: null, mx40IntakeTemp: null });
    }
  }

  // --- Temperature Alert Logic ---
  const highThresholds = { mrtgS: 60, mx40Re: 60, mx40Intake: 75 };
  const warningThresholds = { mrtgS: 58, mx40Re: 58, mx40Intake: 73 };
  const tempElements = {
    statusIndicator: document.getElementById('temp-status-indicator'),
    statusText: document.getElementById('temp-status-text'),
    mrtgS: document.getElementById('mrtg-s-temp'),
    mx40Re: document.getElementById('mx40-re-temp'),
    mx40Intake: document.getElementById('mx40-intake-temp'),
    logTableBody: document.getElementById('temp-log-table-body')
  };
  const alertSound = document.getElementById('alert-sound');

  function processSensorData(data) {
    const now = new Date();
    const sensorDataMap = {
      mrtgS: { value: data.mrtgTemp, element: tempElements.mrtgS, high: highThresholds.mrtgS, warn: warningThresholds.mrtgS, name: "MRTG S." },
      mx40Re: { value: data.mx40ReTemp, element: tempElements.mx40Re, high: highThresholds.mx40Re, warn: warningThresholds.mx40Re, name: "MX40-A RE" },
      mx40Intake: { value: data.mx40IntakeTemp, element: tempElements.mx40Intake, high: highThresholds.mx40Intake, warn: warningThresholds.mx40Intake, name: "MX40-A Intake" }
    };

    let overallStatus = 'Normal';
    let activeAlerts = 0;

    // Update individual sensor statuses and log changes
    for (const key in sensorDataMap) {
      const sensor = sensorDataMap[key];
      let currentSensorStatus = 'Normal';

      if (sensor.value !== null) {
        if (sensor.value >= sensor.high) {
          currentSensorStatus = 'High Alert';
        } else if (sensor.value >= sensor.warn) {
          currentSensorStatus = 'Warning';
        }
      }

      if (currentSensorStatus !== 'Normal') {
        activeAlerts++;
      }

      if (currentSensorStatus !== sensorStates[key].lastStatus) {
        const duration = calculateDuration(now, sensorStates[key].lastTimestamp);
        logTempStatus(sensor.name, currentSensorStatus, duration);
        if (currentSensorStatus === 'High Alert' && sensorStates[key].lastStatus !== 'High Alert') {
          alertSound.play().catch(e => console.error("Audio play failed:", e));
        }
        sensorStates[key].lastStatus = currentSensorStatus;
        sensorStates[key].lastTimestamp = now;
      }

      updateSingleTempElement(sensor.element, sensor.value, sensor.high, sensor.warn);
    }

    // Update the main status indicator based on the most severe alert
    tempElements.statusText.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500');
    tempElements.statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');

    if (activeAlerts > 0) {
      const hasHighAlert = Object.values(sensorStates).some(state => state.lastStatus === 'High Alert');
      if (hasHighAlert) {
        tempElements.statusText.textContent = 'ALERT!';
        tempElements.statusText.classList.add('text-red-500');
        tempElements.statusIndicator.classList.add('bg-red-500');
      } else {
        tempElements.statusText.textContent = 'WARNING';
        tempElements.statusText.classList.add('text-yellow-500');
        tempElements.statusIndicator.classList.add('bg-yellow-500');
      }
    } else {
      tempElements.statusText.textContent = 'Normal';
      tempElements.statusText.classList.add('text-green-500');
      tempElements.statusIndicator.classList.add('bg-green-500');
    }
  }

  function calculateDuration(now, lastTimestamp) {
    if (lastTimestamp) {
      const diff = now - lastTimestamp;
      const seconds = Math.floor(diff / 1000);
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ${minutes % 60}m`;
      const days = Math.floor(hours / 24);
      return `${days}d ${hours % 24}h`;
    }
    return '0s';
  }

  function updateSingleTempElement(element, value, highThreshold, warningThreshold) {
    if (value !== null) {
      element.textContent = `${value} °C`;
      element.classList.remove('text-green-400', 'text-yellow-400', 'text-red-500', 'text-gray-200', 'blinking-alert');
      if (value >= highThreshold) {
        element.classList.add('text-red-500', 'blinking-alert');
      } else if (value >= warningThreshold) {
        element.classList.add('text-yellow-400');
      } else {
        element.classList.add('text-green-400');
      }
    } else {
      element.textContent = '-- °C';
      element.classList.remove('text-green-400', 'text-yellow-400', 'text-red-500', 'blinking-alert');
      element.classList.add('text-gray-200');
    }
  }

  // --- SQL.js and IndexedDB Persistence Logic ---
  const DB_NAME = 'tempMonitorDB';
  const DB_STORE_NAME = 'sqliteData';
  let SQL, db;
  const clearLogsBtn = document.getElementById('clear-logs-btn');

  async function initDb() {
    SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
    const data = await loadDbFromIndexedDB();
    if (data) {
      db = new SQL.Database(data);
    } else {
      db = new SQL.Database();
      db.exec(`CREATE TABLE temperature_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, sensors TEXT NOT NULL, status TEXT NOT NULL, duration TEXT NOT NULL);`);
      await saveDbToIndexedDB();
    }
    await updateTempLogTable(tempElements.logTableBody);
    clearLogsBtn.disabled = false;
  }

  async function saveDbToIndexedDB() {
    if (!db) return;
    const data = db.export();
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onupgradeneeded = e => e.target.result.createObjectStore(DB_STORE_NAME);
      request.onsuccess = e => {
        const transaction = e.target.result.transaction([DB_STORE_NAME], 'readwrite');
        const putRequest = transaction.objectStore(DB_STORE_NAME).put(data, 'main');
        putRequest.onsuccess = () => resolve();
        putRequest.onerror = err => reject(err);
      };
      request.onerror = e => reject(e.target.error);
    });
  }

  async function loadDbFromIndexedDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onupgradeneeded = e => e.target.result.createObjectStore(DB_STORE_NAME);
      request.onsuccess = e => {
        const transaction = e.target.result.transaction([DB_STORE_NAME], 'readonly');
        const getRequest = transaction.objectStore(DB_STORE_NAME).get('main');
        getRequest.onsuccess = () => resolve(getRequest.result || null);
        getRequest.onerror = err => reject(err);
      };
      request.onerror = e => reject(e.target.error);
    });
  }

  async function deleteDbFromIndexedDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onsuccess = e => {
        const transaction = e.target.result.transaction([DB_STORE_NAME], 'readwrite');
        const deleteRequest = transaction.objectStore(DB_STORE_NAME).delete('main');
        deleteRequest.onsuccess = () => resolve();
        deleteRequest.onerror = err => reject(err);
      };
      request.onerror = e => reject(e.target.error);
    });
  }

  function logTempStatus(sensors, status, duration) {
    if (!db) return;
    const timestamp = new Date().toISOString();
    const statement = db.prepare(`INSERT INTO temperature_logs (timestamp, sensors, status, duration) VALUES (?, ?, ?, ?)`);
    try {
      statement.run([timestamp, sensors, status, duration]);
      saveDbToIndexedDB();
      updateTempLogTable(tempElements.logTableBody);
    } catch (e) {
      console.error('Error executing SQL:', e);
    } finally {
      statement.free();
    }
  }

  async function updateTempLogTable(tableBodyElement) {
    if (!db) return;
    tableBodyElement.innerHTML = '';
    try {
      const res = db.exec("SELECT timestamp, sensors, status, duration FROM temperature_logs ORDER BY id DESC");
      if (res.length === 0 || res[0].values.length === 0) {
        tableBodyElement.innerHTML = `<tr><td colspan="4" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>`;
        return;
      }
      const rows = res[0].values;
      rows.forEach(row => {
        const [isoTimestamp, sensors, status, duration] = row;
        const date = new Date(isoTimestamp);
        const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const dateString = date.toLocaleDateString();
        let statusColor = 'text-green-400';
        if (status === 'High Alert') {
          statusColor = 'text-red-500';
        } else if (status === 'Warning') {
          statusColor = 'text-yellow-500';
        }
        const newRow = tableBodyElement.insertRow();
        newRow.className = 'hover:bg-gray-700';
        newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm text-gray-400 font-mono"><span class="block">${dateString}</span><span class="text-xs text-gray-500">${timeString}</span></div>`;
        newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm text-gray-300">${sensors}</div>`;
        newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm font-semibold ${statusColor}">${status}</div>`;
        newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm text-gray-300">${duration}</div>`;
      });
    } catch (e) {
      console.error('Error querying temperature logs:', e);
    }
  }

  async function clearAllLogs() {
    if (!confirm('Are you sure you want to clear all temperature history? This is irreversible.')) return;
    try {
      db.exec("DROP TABLE IF EXISTS temperature_logs;");
      db.exec("CREATE TABLE temperature_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, sensors TEXT NOT NULL, status TEXT NOT NULL, duration TEXT NOT NULL);");
      await deleteDbFromIndexedDB();
      await saveDbToIndexedDB();
      // Reset sensor states
      for(const key in sensorStates) {
        sensorStates[key].lastStatus = 'Normal';
        sensorStates[key].lastTimestamp = null;
      }
      await updateTempLogTable(tempElements.logTableBody);
      alert('All temperature logs cleared.');
    } catch (error) {
      console.error('Error clearing logs:', error);
      alert('Failed to clear logs.');
    }
  }

  clearLogsBtn.addEventListener('click', clearAllLogs);
  initDb();
  setInterval(updateDashboardData, 1000);
  updateDashboardData();
  window.addEventListener('beforeunload', saveDbToIndexedDB);

</script>

</body>
</html>