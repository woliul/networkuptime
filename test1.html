<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOC-ISP Combined Dashboard</title>
    <link rel="icon" type="image/png" href="./assets/tempalert.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .blinking-alert {
            animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
            50% { opacity: 0; }
        }
        /* Custom scrollbar for log tables */
        .log-table-container::-webkit-scrollbar {
            width: 8px;
        }
        .log-table-container::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }
        .log-table-container::-webkit-scrollbar-track {
            background: #1f2937; /* Gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 md:p-8">

<div class="max-w-6xl mx-auto bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 p-6 md:p-8">

    <div class="flex border-b border-gray-700 mb-6">
        <button class="tab-button active px-4 py-2 text-sm md:text-base font-medium text-gray-300 hover:text-white border-b-2 border-transparent transition-colors duration-200" data-tab="dashboard">Combined Dashboard</button>
        <button class="tab-button px-4 py-2 text-sm md:text-base font-medium text-gray-300 hover:text-white border-b-2 border-transparent transition-colors duration-200" data-tab="temperature">Temperature Alert</button>
        <button class="tab-button px-4 py-2 text-sm md:text-base font-medium text-gray-300 hover:text-white border-b-2 border-transparent transition-colors duration-200" data-tab="network">Network Log</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <h1 class="text-3xl font-bold text-gray-100 mb-6">NOC-ISP Combined Dashboard</h1>

        <div class="grid lg:grid-cols-2 gap-8">
            <div class="bg-gray-700 rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-100">Temperature Monitor</h2>
                    <div class="flex items-center space-x-2">
                        <span id="temp-status-text" class="text-sm font-medium"></span>
                        <div id="temp-status-indicator" class="w-4 h-4 rounded-full bg-yellow-500"></div>
                    </div>
                </div>
                <div class="space-y-4" id="monitoring-results">
                    <div class="p-4 bg-gray-600 rounded-lg flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-lg">MRTG S. Temperature</h3>
                            <p class="text-sm text-gray-400">i350bb-pci-0600</p>
                        </div>
                        <div class="text-right">
                            <p id="mrtg-s-temp" class="text-2xl font-bold text-gray-200">-- ¬∞C</p>
                            <p class="text-xs text-gray-400">Threshold: 60 ¬∞C</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-600 rounded-lg flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-lg">MX40-A Temp (Routing Engine)</h3>
                            <p class="text-sm text-gray-400">Routing Engine Sensor</p>
                        </div>
                        <div class="text-right">
                            <p id="mx40-re-temp" class="text-2xl font-bold text-gray-200">-- ¬∞C</p>
                            <p class="text-xs text-gray-400">Threshold: 60 ¬∞C</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-600 rounded-lg flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-lg">MX40-A Temp (Intake)</h3>
                            <p class="text-sm text-gray-400">Intake Air Sensor</p>
                        </div>
                        <div class="text-right">
                            <p id="mx40-intake-temp" class="text-2xl font-bold text-gray-200">-- ¬∞C</p>
                            <p class="text-xs text-gray-400">Threshold: 75 ¬∞C</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-gray-200 mb-3 flex justify-between items-center">
                        Temperature Log
                    </h3>
                    <div class="log-table-container max-h-48 overflow-y-auto bg-gray-900 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Sensor</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                            </tr>
                            </thead>
                            <tbody id="temp-log-table-body-dashboard" class="divide-y divide-gray-700">
                            <tr><td colspan="3" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="bg-gray-700 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-100 mb-4">Network Link Status</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-200 mb-2">Primary Link</h3>
                        <div id="primary-status-display" class="p-3 text-center rounded-lg font-mono text-xl transition-colors duration-300 bg-gray-600 text-gray-300">
                            Initializing...
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-200 mb-2">Secondary Link</h3>
                        <div id="secondary-status-display" class="p-3 text-center rounded-lg font-mono text-xl transition-colors duration-300 bg-gray-600 text-gray-300">
                            Initializing...
                        </div>
                        <img src="./assets/router.png" alt="Image of a router" class="hidden">
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold text-gray-200 mb-3 flex justify-between items-center">
                        Status Change History
                        <button id="clear-logs-btn" class="text-sm px-3 py-1 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition duration-150 shadow-sm disabled:opacity-50">
                            Clear All Logs
                        </button>
                    </h3>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-medium text-gray-300 mb-2">Primary Link Log</h4>
                            <div class="log-table-container max-h-80 overflow-y-auto bg-gray-900 rounded-lg">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                    </tr>
                                    </thead>
                                    <tbody id="primary-log-table-body" class="divide-y divide-gray-700">
                                    <tr><td colspan="2" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-medium text-gray-300 mb-2">Secondary Link Log</h4>
                            <div class="log-table-container max-h-80 overflow-y-auto bg-gray-900 rounded-lg">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                    </tr>
                                    </thead>
                                    <tbody id="secondary-log-table-body" class="divide-y divide-gray-700">
                                    <tr><td colspan="2" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="temperature" class="tab-content">
        <div class="w-full max-w-4xl mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-100">Temperature Monitor</h1>
                <div class="flex items-center space-x-2">
                    <span id="temp-status-text-tab" class="text-sm font-medium"></span>
                    <div id="temp-status-indicator-tab" class="w-4 h-4 rounded-full bg-yellow-500"></div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-gray-700 rounded-lg flex justify-between items-center">
                    <div>
                        <h2 class="font-semibold text-lg">MRTG S. Temperature</h2>
                        <p class="text-sm text-gray-400">i350bb-pci-0600</p>
                    </div>
                    <div class="text-right">
                        <p id="mrtg-s-temp-tab" class="text-2xl font-bold text-gray-200">-- ¬∞C</p>
                        <p class="text-xs text-gray-500">Threshold: 60 ¬∞C</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-700 rounded-lg flex justify-between items-center">
                    <div>
                        <h2 class="font-semibold text-lg">MX40-A Temp (Routing Engine)</h2>
                        <p class="text-sm text-gray-400">Routing Engine Sensor</p>
                    </div>
                    <div class="text-right">
                        <p id="mx40-re-temp-tab" class="text-2xl font-bold text-gray-200">-- ¬∞C</p>
                        <p class="text-xs text-gray-500">Threshold: 60 ¬∞C</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-700 rounded-lg flex justify-between items-center">
                    <div>
                        <h2 class="font-semibold text-lg">MX40-A Temp (Intake)</h2>
                        <p class="text-sm text-gray-400">Intake Air Sensor</p>
                    </div>
                    <div class="text-right">
                        <p id="mx40-intake-temp-tab" class="text-2xl font-bold text-gray-200">-- ¬∞C</p>
                        <p class="text-xs text-gray-500">Threshold: 75 ¬∞C</p>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-200 mb-3 flex justify-between items-center">
                    Temperature Log
                </h3>
                <div class="log-table-container max-h-48 overflow-y-auto bg-gray-900 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Sensor</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        </tr>
                        </thead>
                        <tbody id="temp-log-table-body-tab" class="divide-y divide-gray-700">
                        <tr><td colspan="3" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="network" class="tab-content">
        <div class="max-w-4xl mx-auto bg-gray-800 shadow-xl rounded-lg p-6 md:p-8">
            <h1 class="text-3xl font-bold text-gray-100 mb-4 flex items-center">
                <span class="mr-2">üåê</span> Network Link Monitor
            </h1>
            <p class="text-sm text-gray-400 mb-6">
                Monitoring link status with client-side persistence.
            </p>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-gray-200 mb-2">Primary Link Status</h2>
                    <div id="primary-status-display-tab" class="p-3 text-center rounded-lg font-mono text-xl transition-colors duration-300 bg-gray-600 text-gray-300">
                        Initializing...
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-200 mb-2">Secondary Link Status</h2>
                    <div id="secondary-status-display-tab" class="p-3 text-center rounded-lg font-mono text-xl transition-colors duration-300 bg-gray-600 text-gray-300">
                        Initializing...
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <h2 class="text-xl font-semibold text-gray-200 mb-3 flex justify-between items-center">
                    Connection History
                    <button id="clear-logs-btn-tab" class="text-sm px-3 py-1 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition duration-150 shadow-sm disabled:opacity-50">
                        Clear Logs
                    </button>
                </h2>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-300 mb-2">Primary Link Log</h4>
                        <div class="log-table-container max-h-80 overflow-y-auto bg-gray-900 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                </tr>
                                </thead>
                                <tbody id="primary-log-table-body-tab" class="divide-y divide-gray-700">
                                <tr><td colspan="2" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-medium text-gray-300 mb-2">Secondary Link Log</h4>
                        <div class="log-table-container max-h-80 overflow-y-auto bg-gray-900 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Timestamp</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                </tr>
                                </thead>
                                <tbody id="secondary-log-table-body-tab" class="divide-y divide-gray-700">
                                <tr><td colspan="2" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="alert-sound" src="./assets/alert.mp3" preload="auto"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script>
    // Tab switching logic
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(item => item.classList.remove('active', 'border-indigo-500', 'text-white'));
            tabContents.forEach(content => content.classList.remove('active'));

            tab.classList.add('active', 'border-indigo-500', 'text-white');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // --- Core Data Fetching and Parsing Logic ---
    const TEMP_DATA_URL = './temp.html';

    async function fetchData() {
        try {
            const response = await fetch(TEMP_DATA_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const htmlString = await response.text();

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const bodyText = doc.body.innerText;

            const data = {
                primaryStatus: null,
                secondaryStatus: null,
                mrtgTemp: null,
                mx40ReTemp: null,
                mx40IntakeTemp: null
            };

            // Parse link statuses
            const primaryMatch = bodyText.match(/Primary Link\(.+\):.*?(\w+)/);
            if (primaryMatch) data.primaryStatus = primaryMatch[1].trim().toUpperCase();

            const secondaryMatch = bodyText.match(/Secondary Link\(.+\):.*?(\w+)/);
            if (secondaryMatch) data.secondaryStatus = secondaryMatch[1].trim().toUpperCase();

            // Parse temperatures
            const mrtgMatch = bodyText.match(/MRTG S\. Temperature\(.+?\):.*?(\d+)\s*¬∞C/);
            if (mrtgMatch) data.mrtgTemp = parseInt(mrtgMatch[1], 10);

            const mx40LineMatch = bodyText.match(/MX40-A Temperature\(Routing Engine\):.*?(\d+)\s*¬∞C.*?Intake:(\d+)\s*¬∞C/);
            if (mx40LineMatch) {
                data.mx40ReTemp = parseInt(mx40LineMatch[1], 10);
                data.mx40IntakeTemp = parseInt(mx40LineMatch[2], 10);
            }

            return data;

        } catch (error) {
            console.error('Fetch Error:', error);
            // Return null or a default object to indicate failure
            return {
                primaryStatus: 'DOWN',
                secondaryStatus: 'DOWN',
                mrtgTemp: null,
                mx40ReTemp: null,
                mx40IntakeTemp: null
            };
        }
    }

    let lastKnownTempStatus = 'Normal';
    let lastMrtgTemp = null;
    let lastMx40ReTemp = null;
    let lastMx40IntakeTemp = null;

    async function updateDashboardData() {
        const data = await fetchData();
        if (data) {
            updateTemperatureUI(data.mrtgTemp, data.mx40ReTemp, data.mx40IntakeTemp);
            updateNetworkUI(data.primaryStatus, data.secondaryStatus);
        } else {
            // Handle case where fetch failed
            updateTemperatureUI(null, null, null);
            updateNetworkUI('DOWN', 'DOWN');
        }
    }

    // --- Temperature Alert Logic ---
    const highThresholds = { mrtgS: 60, mx40Re: 60, mx40Intake: 75 };
    const warningThresholds = { mrtgS: 58, mx40Re: 58, mx40Intake: 73 };
    const tempElements = {
        dashboard: {
            statusIndicator: document.getElementById('temp-status-indicator'),
            statusText: document.getElementById('temp-status-text'),
            mrtgS: document.getElementById('mrtg-s-temp'),
            mx40Re: document.getElementById('mx40-re-temp'),
            mx40Intake: document.getElementById('mx40-intake-temp'),
            logTableBody: document.getElementById('temp-log-table-body-dashboard')
        },
        tab: {
            statusIndicator: document.getElementById('temp-status-indicator-tab'),
            statusText: document.getElementById('temp-status-text-tab'),
            mrtgS: document.getElementById('mrtg-s-temp-tab'),
            mx40Re: document.getElementById('mx40-re-temp-tab'),
            mx40Intake: document.getElementById('mx40-intake-temp-tab'),
            logTableBody: document.getElementById('temp-log-table-body-tab')
        }
    };
    const alertSound = document.getElementById('alert-sound');

    function updateTemperatureUI(mrtgSValue, mx40ReValue, mx40IntakeValue) {
        let currentStatus = 'Normal';
        let statusSensors = { High: [], Warning: [] };

        // Check for high temperatures
        if (mrtgSValue !== null) {
            if (mrtgSValue >= highThresholds.mrtgS) statusSensors.High.push("MRTG S.");
            else if (mrtgSValue >= warningThresholds.mrtgS) statusSensors.Warning.push("MRTG S.");
        }
        if (mx40ReValue !== null) {
            if (mx40ReValue >= highThresholds.mx40Re) statusSensors.High.push("MX40-A RE");
            else if (mx40ReValue >= warningThresholds.mx40Re) statusSensors.Warning.push("MX40-A RE");
        }
        if (mx40IntakeValue !== null) {
            if (mx40IntakeValue >= highThresholds.mx40Intake) statusSensors.High.push("MX40-A Intake");
            else if (mx40IntakeValue >= warningThresholds.mx40Intake) statusSensors.Warning.push("MX40-A Intake");
        }

        if (statusSensors.High.length > 0) {
            currentStatus = 'High Alert';
        } else if (statusSensors.Warning.length > 0) {
            currentStatus = 'Warning';
        }

        // Update UI for both tabs
        ['dashboard', 'tab'].forEach(view => {
            const elements = tempElements[view];
            updateSingleTempElement(elements.mrtgS, mrtgSValue, highThresholds.mrtgS, warningThresholds.mrtgS);
            updateSingleTempElement(elements.mx40Re, mx40ReValue, highThresholds.mx40Re, warningThresholds.mx40Re);
            updateSingleTempElement(elements.mx40Intake, mx40IntakeValue, highThresholds.mx40Intake, warningThresholds.mx40Intake);

            elements.statusText.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500');
            elements.statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');

            if (currentStatus === 'High Alert') {
                elements.statusText.textContent = 'ALERT!';
                elements.statusText.classList.add('text-red-500');
                elements.statusIndicator.classList.add('bg-red-500');
            } else if (currentStatus === 'Warning') {
                elements.statusText.textContent = 'WARNING';
                elements.statusText.classList.add('text-yellow-500');
                elements.statusIndicator.classList.add('bg-yellow-500');
            } else {
                elements.statusText.textContent = 'Normal';
                elements.statusText.classList.add('text-green-500');
                elements.statusIndicator.classList.add('bg-green-500');
            }
        });

        // Log status change if necessary
        if (currentStatus !== lastKnownTempStatus) {
            let sensorsToLog = 'N/A';
            if (currentStatus === 'High Alert') {
                sensorsToLog = statusSensors.High.join(', ');
                alertSound.play().catch(e => console.error("Audio play failed:", e));
            } else if (currentStatus === 'Warning') {
                sensorsToLog = statusSensors.Warning.join(', ');
            } else if (currentStatus === 'Normal') {
                // Determine which sensors returned to normal
                let normalSensors = [];
                if (lastMrtgTemp !== null && lastMrtgTemp >= warningThresholds.mrtgS && mrtgSValue < warningThresholds.mrtgS) {
                    normalSensors.push("MRTG S.");
                }
                if (lastMx40ReTemp !== null && lastMx40ReTemp >= warningThresholds.mx40Re && mx40ReValue < warningThresholds.mx40Re) {
                    normalSensors.push("MX40-A RE");
                }
                if (lastMx40IntakeTemp !== null && lastMx40IntakeTemp >= warningThresholds.mx40Intake && mx40IntakeValue < warningThresholds.mx40Intake) {
                    normalSensors.push("MX40-A Intake");
                }
                sensorsToLog = `Sensors back to normal: ${normalSensors.join(', ')}`;
            }
            logTempStatus(currentStatus, sensorsToLog);
            lastKnownTempStatus = currentStatus;
        }

        // Update last known temperatures for the next check
        lastMrtgTemp = mrtgSValue;
        lastMx40ReTemp = mx40ReValue;
        lastMx40IntakeTemp = mx40IntakeValue;
    }

    function updateSingleTempElement(element, value, highThreshold, warningThreshold) {
        if (value !== null) {
            element.textContent = `${value} ¬∞C`;
            element.classList.remove('text-green-400', 'text-yellow-400', 'text-red-500', 'text-gray-200', 'blinking-alert');
            if (value >= highThreshold) {
                element.classList.add('text-red-500', 'blinking-alert');
            } else if (value >= warningThreshold) {
                element.classList.add('text-yellow-400');
            } else {
                element.classList.add('text-green-400');
            }
        } else {
            element.textContent = '-- ¬∞C';
            element.classList.remove('text-green-400', 'text-yellow-400', 'text-red-500', 'blinking-alert');
            element.classList.add('text-gray-200');
        }
    }

    // --- Network Log Logic ---
    const DB_NAME = 'networkMonitorDB';
    const DB_STORE_NAME = 'sqliteData';
    let SQL, db;
    let lastKnownPrimaryStatus = null;
    let lastKnownSecondaryStatus = null;

    const networkElements = {
        dashboard: {
            primaryDisplay: document.getElementById('primary-status-display'),
            secondaryDisplay: document.getElementById('secondary-status-display'),
            primaryLogBody: document.getElementById('primary-log-table-body'),
            secondaryLogBody: document.getElementById('secondary-log-table-body'),
        },
        tab: {
            primaryDisplay: document.getElementById('primary-status-display-tab'),
            secondaryDisplay: document.getElementById('secondary-status-display-tab'),
            primaryLogBody: document.getElementById('primary-log-table-body-tab'),
            secondaryLogBody: document.getElementById('secondary-log-table-body-tab'),
        }
    };
    const clearLogsBtn = document.getElementById('clear-logs-btn');
    const clearLogsBtnTab = document.getElementById('clear-logs-btn-tab');

    async function initDb() {
        SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
        const data = await loadDbFromIndexedDB();
        if (data) {
            db = new SQL.Database(data);
        } else {
            db = new SQL.Database();
            db.exec(`
                CREATE TABLE primary_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, status TEXT NOT NULL);
                CREATE TABLE secondary_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, status TEXT NOT NULL);
                CREATE TABLE temperature_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, sensors TEXT NOT NULL, status TEXT NOT NULL);
            `);
            await saveDbToIndexedDB();
        }
        await updateAllLogDisplays();
        clearLogsBtn.disabled = false;
        clearLogsBtnTab.disabled = false;
    }

    async function saveDbToIndexedDB() {
        if (!db) return;
        const data = db.export();
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = e => e.target.result.createObjectStore(DB_STORE_NAME);
            request.onsuccess = e => {
                const transaction = e.target.result.transaction([DB_STORE_NAME], 'readwrite');
                const putRequest = transaction.objectStore(DB_STORE_NAME).put(data, 'main');
                putRequest.onsuccess = () => resolve();
                putRequest.onerror = err => reject(err);
            };
            request.onerror = e => reject(e.target.error);
        });
    }

    async function loadDbFromIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = e => e.target.result.createObjectStore(DB_STORE_NAME);
            request.onsuccess = e => {
                const transaction = e.target.result.transaction([DB_STORE_NAME], 'readonly');
                const getRequest = transaction.objectStore(DB_STORE_NAME).get('main');
                getRequest.onsuccess = () => resolve(getRequest.result || null);
                getRequest.onerror = err => reject(err);
            };
            request.onerror = e => reject(e.target.error);
        });
    }

    async function deleteDbFromIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onsuccess = e => {
                const transaction = e.target.result.transaction([DB_STORE_NAME], 'readwrite');
                const deleteRequest = transaction.objectStore(DB_STORE_NAME).delete('main');
                deleteRequest.onsuccess = () => resolve();
                deleteRequest.onerror = err => reject(err);
            };
            request.onerror = e => reject(e.target.error);
        });
    }

    function logLinkStatus(link, status) {
        if (!db) return;
        const tableName = `${link.toLowerCase()}_logs`;
        const timestamp = new Date().toISOString();
        const statement = db.prepare(`INSERT INTO ${tableName} (timestamp, status) VALUES (?, ?)`);
        try {
            statement.run([timestamp, status]);
            saveDbToIndexedDB();
            updateAllLogDisplays();
        } catch (e) {
            console.error('Error executing SQL:', e);
        } finally {
            statement.free();
        }
    }

    function logTempStatus(status, sensors) {
        if (!db) return;
        const timestamp = new Date().toISOString();
        const statement = db.prepare(`INSERT INTO temperature_logs (timestamp, sensors, status) VALUES (?, ?, ?)`);
        try {
            statement.run([timestamp, sensors, status]);
            saveDbToIndexedDB();
            updateAllLogDisplays();
        } catch (e) {
            console.error('Error executing SQL:', e);
        } finally {
            statement.free();
        }
    }

    function updateNetworkUI(primaryStatus, secondaryStatus) {
        ['dashboard', 'tab'].forEach(view => {
            const elements = networkElements[view];
            updateSingleNetworkElement(elements.primaryDisplay, primaryStatus);
            updateSingleNetworkElement(elements.secondaryDisplay, secondaryStatus);
        });

        if (primaryStatus !== lastKnownPrimaryStatus && primaryStatus !== null) {
            logLinkStatus('primary', primaryStatus);
            lastKnownPrimaryStatus = primaryStatus;
        }
        if (secondaryStatus !== lastKnownSecondaryStatus && secondaryStatus !== null) {
            logLinkStatus('secondary', secondaryStatus);
            lastKnownSecondaryStatus = secondaryStatus;
        }
    }

    function updateSingleNetworkElement(element, status) {
        element.textContent = status;
        element.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-gray-600', 'text-gray-300');
        if (status === 'UP') {
            element.classList.add('bg-green-100', 'text-green-700');
        } else if (status === 'DOWN') {
            element.classList.add('bg-red-100', 'text-red-700');
        } else {
            element.classList.add('bg-gray-600', 'text-gray-300');
            element.textContent = 'Initializing...';
        }
    }

    async function updateAllLogDisplays() {
        await updateLogTable('primary', networkElements.dashboard.primaryLogBody);
        await updateLogTable('secondary', networkElements.dashboard.secondaryLogBody);
        await updateLogTable('primary', networkElements.tab.primaryLogBody);
        await updateLogTable('secondary', networkElements.tab.secondaryLogBody);
        await updateTempLogTable(tempElements.dashboard.logTableBody);
        await updateTempLogTable(tempElements.tab.logTableBody);
    }

    async function updateLogTable(link, tableBodyElement) {
        if (!db) return;
        tableBodyElement.innerHTML = '';
        const tableName = `${link}_logs`;
        try {
            const res = db.exec(`SELECT timestamp, status FROM ${tableName} ORDER BY id DESC`);
            if (res.length === 0 || res[0].values.length === 0) {
                tableBodyElement.innerHTML = `<tr><td colspan="2" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>`;
                return;
            }
            const rows = res[0].values;
            rows.forEach(row => {
                const [isoTimestamp, status] = row;
                const date = new Date(isoTimestamp);
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateString = date.toLocaleDateString();
                const statusColor = status === 'UP' ? 'text-green-400' : 'text-red-500';
                const newRow = tableBodyElement.insertRow();
                newRow.className = 'hover:bg-gray-700';
                newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm text-gray-400 font-mono"><span class="block">${dateString}</span><span class="text-xs text-gray-500">${timeString}</span></div>`;
                newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm font-semibold ${statusColor}">${status}</div>`;
            });
        } catch (e) {
            console.error(`Error querying ${link} logs:`, e);
        }
    }

    async function updateTempLogTable(tableBodyElement) {
        if (!db) return;
        tableBodyElement.innerHTML = '';
        try {
            const res = db.exec("SELECT timestamp, sensors, status FROM temperature_logs ORDER BY id DESC");
            if (res.length === 0 || res[0].values.length === 0) {
                tableBodyElement.innerHTML = `<tr><td colspan="3" class="px-4 py-4 text-sm text-gray-500 text-center">No history yet.</td></tr>`;
                return;
            }
            const rows = res[0].values;
            rows.forEach(row => {
                const [isoTimestamp, sensors, status] = row;
                const date = new Date(isoTimestamp);
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateString = date.toLocaleDateString();
                let statusColor = 'text-green-400';
                if (status === 'High Alert') {
                    statusColor = 'text-red-500';
                } else if (status === 'Warning') {
                    statusColor = 'text-yellow-500';
                }
                const newRow = tableBodyElement.insertRow();
                newRow.className = 'hover:bg-gray-700';
                newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm text-gray-400 font-mono"><span class="block">${dateString}</span><span class="text-xs text-gray-500">${timeString}</span></div>`;
                newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm text-gray-300">${sensors}</div>`;
                newRow.insertCell().innerHTML = `<div class="px-4 py-2 text-sm font-semibold ${statusColor}">${status}</div>`;
            });
        } catch (e) {
            console.error('Error querying temperature logs:', e);
        }
    }

    async function clearAllLogs() {
        if (!confirm('Are you sure you want to clear all connection history? This is irreversible.')) return;
        try {
            db.exec("DROP TABLE IF EXISTS primary_logs; DROP TABLE IF EXISTS secondary_logs; DROP TABLE IF EXISTS temperature_logs;");
            db.exec("CREATE TABLE primary_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, status TEXT NOT NULL);");
            db.exec("CREATE TABLE secondary_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, status TEXT NOT NULL);");
            db.exec("CREATE TABLE temperature_logs (id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TEXT NOT NULL, sensors TEXT NOT NULL, status TEXT NOT NULL);");
            await deleteDbFromIndexedDB();
            await saveDbToIndexedDB();
            lastKnownPrimaryStatus = null;
            lastKnownSecondaryStatus = null;
            lastKnownTempStatus = 'Normal';
            lastMrtgTemp = null;
            lastMx40ReTemp = null;
            lastMx40IntakeTemp = null;
            await updateAllLogDisplays();
            alert('All logs cleared.');
        } catch (error) {
            console.error('Error clearing logs:', error);
            alert('Failed to clear logs.');
        }
    }

    clearLogsBtn.addEventListener('click', clearAllLogs);
    clearLogsBtnTab.addEventListener('click', clearAllLogs);

    initDb();
    setInterval(() => {
        updateDashboardData();
    }, 1000);

    window.addEventListener('beforeunload', saveDbToIndexedDB);
</script>
</body>
</html>